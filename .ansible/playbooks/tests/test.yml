---
- include: "{{GRUNNER_TOP_DIR}}/ansible/playbooks/lxc/register.yml"
- include: "{{GRUNNER_TOP_DIR}}/ansible/playbooks/vars.yml"
  vars: {inc_node: "{{TEST_LXC_NAME}}"}
- hosts: "{{TEST_LXC_NAME}}"
  tasks:
    - name: test if we have pillar file
      stat: {path: "{{ms_pillar}}"}
      register: project_test_pillar_test
      failed_when: false
      when: "{{TEST_USE_MAKINASTATES}}"
      tags: project_test,project_test_ms
    - name: switch db1 to superuser
      postgresql_user:
        name: db1
        role_attr_flags: SUPERUSER
      when: "{{TEST_USE_MAKINASTATES}}"
      tags: project_test,project_test_ms
    - name: test project under makina-states
      shell: |
             cd {{TEST_PROJECT_PATH}} && \
             source venv/bin/activate && \
             tox -e pylama,isort,py35-std,py35-reverse,py35-coverage
      when: "{{TEST_USE_MAKINASTATES and project_test_pillar_test.stat.exists}}"
      tags: project_test
    - name: test project without makina-states
      shell: |
             /bin/true
      when: "{{not (TEST_USE_MAKINASTATES and project_test_pillar_test.stat.exists)}}"
      tags: project_test
